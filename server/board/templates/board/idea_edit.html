{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Éditer — {{ idea.title }} — StudioBoard</title>
  <link rel="stylesheet" href="{% static 'board/idea_form.css' %}">
  <link rel="stylesheet" href="{% static 'board/md_preview.css' %}">
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div>
        <div style="opacity:.8; font-size:12px;">StudioBoard</div>
        <div style="font-size:18px; font-weight:750;">Éditer l’idée</div>
        <div style="opacity:.8; font-size:12px;">{{ idea.title }}</div>
      </div>
      <div class="actions">
        <a class="btn secondary" href="{% url 'board:idea_detail' board.id idea.id %}">← Annuler</a>
        <a class="btn secondary" href="{% url 'board:kanban' board.id %}">Board</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="card" style="margin-bottom:12px;">
      <form method="post" action="{% url 'board:idea_apply_template' board.id idea.id %}" onsubmit="return confirmTemplateApply();" style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
        {% csrf_token %}
        <div style="flex:1; min-width:260px;">
          <label>Template</label>
          <select name="template_id" required>
            <option value="" disabled selected>Choisir un template…</option>
            {% for t in templates %}
              <option value="{{ t.id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
          <div class="help">Remplace le contenu Markdown actuel.</div>
        </div>
        <button class="btn" type="submit" style="height:42px;">Appliquer</button>
      </form>
    </div>

    <div class="card">
      <form method="post" novalidate>
        {% csrf_token %}

        <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
        {{ form.title }}
        {% if form.title.errors %}<div class="error">{{ form.title.errors|striptags }}</div>{% endif %}

        <div class="row">
          <div>
            <label for="{{ form.column.id_for_label }}">{{ form.column.label }}</label>
            {{ form.column }}
            {% if form.column.errors %}<div class="error">{{ form.column.errors|striptags }}</div>{% endif %}
          </div>
          <div>
            <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
            {{ form.status }}
            {% if form.status.errors %}<div class="error">{{ form.status.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="row">
          <div>
            <label for="{{ form.impact.id_for_label }}">{{ form.impact.label }}</label>
            {{ form.impact }}
            {% if form.impact.errors %}<div class="error">{{ form.impact.errors|striptags }}</div>{% endif %}
          </div>
          <div>
            <label for="{{ form.next_action.id_for_label }}">{{ form.next_action.label }}</label>
            {{ form.next_action }}
            {% if form.next_action.errors %}<div class="error">{{ form.next_action.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <label for="{{ form.tags_text.id_for_label }}">{{ form.tags_text.label }}</label>
        {{ form.tags_text }}
        <div class="help">{{ form.tags_text.help_text }}</div>
        {% if form.tags_text.errors %}<div class="error">{{ form.tags_text.errors|striptags }}</div>{% endif %}

        <label>{{ form.body_md.label }}</label>
        <div class="md-split">
          <div class="md-pane">
            <p class="md-pane-title">Markdown</p>
            <textarea
              name="body_md"
              rows="18"
              class="textarea"
              data-md-preview-target="#ideaPreview"
            >{{ form.body_md.value|default_if_none:"" }}</textarea>
            <div class="help">Édite le Markdown ici — l’aperçu se met à jour automatiquement.</div>
            {% if form.body_md.errors %}<div class="error">{{ form.body_md.errors|striptags }}</div>{% endif %}
          </div>

          <div class="md-pane">
            <p class="md-pane-title">Aperçu</p>
            <div id="ideaPreview" class="md-preview"></div>
            <div class="help">Rendu HTML sécurisé (même moteur que l’affichage final).</div>
          </div>
        </div>

        {% if form.non_field_errors %}<div class="error">{{ form.non_field_errors|striptags }}</div>{% endif %}

        <div class="actions">
          <button class="btn" type="submit">Enregistrer</button>
          <a class="btn secondary" href="{% url 'board:idea_detail' board.id idea.id %}">Annuler</a>
        </div>
      </form>
    </div>
  </div>
  <script src="{% static 'board/md_preview.js' %}" defer></script>
</body>
</html>